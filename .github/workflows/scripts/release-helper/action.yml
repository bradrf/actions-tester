name: Release Helper
description: Evaluates the state of git to determine the kind of release to be run (if any)

runs:
  using: composite
  steps:
    - name: Evaluate state of ${{ github.ref_name }}
      run: |
        echo barf
        git tag -l -n "${tag}" | sed 's/^[^ ]* *//'
        if [ ${{ github.ref_type == 'tag' && startsWith(github.ref_name, 'release-prd-') }} = true ]; then
          kind=production
          abbrev=prd
        elif [ ${{ github.ref_type == 'branch' && github.ref_name == 'main' }} = true -o ${{ github.ref_type == 'tag' && startsWith(github.ref_name, 'release-stg-') }} = true ]; then
          kind=staging
          abbrev=stg
        elif [ ${{ github.event_name == 'pull_request' }} = true ]; then
          kind=preview
          abbrev=pre
        else
          kind=other
          abbrev=oth
        fi
        if [ ${{ github.ref_type == 'tag' }} = true ]; then
          tag='${{ github.ref_name }}'
          if [ ${{ startsWith(github.ref_name, 'release-') }} = true ]; then
            echo "RELEASE_TARGETS=$(git tag -l -n "${tag}" | sed 's/^[^ ]* *//')" >> $GITHUB_ENV
          fi
        else
          tag="release-${kind}-${GITHUB_SHA:0:7}"
          if [ "${kind}" = 'staging' ]; then
            echo 'RELEASE_TARGETS=any' >> $GITHUB_ENV
          fi
        fi
        echo "RELEASE_KIND=${kind}" >> $GITHUB_ENV
        echo "RELEASE_ABBREV=${abbrev}" >> $GITHUB_ENV
        echo "RELEASE_TAG=${tag}" >> $GITHUB_ENV
      shell: bash

    # this is just for getting a chance to see what `env` values have been set before moving on
    - run: 'true'
      shell: bash
